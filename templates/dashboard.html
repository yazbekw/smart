<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¨ÙˆØª ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"  rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .trade-history { font-size: 0.9rem; }
        .signal-box {
            padding: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">ğŸ¤– Ø¨ÙˆØª ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø¨ÙŠØªÙƒÙˆÙŠÙ†</h1>

        <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª -->
        <div class="card mb-4">
            <div class="card-header">Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª</div>
            <div class="card-body">
                <p>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:
                    <span class="badge bg-{{ status.running ? 'success' : 'danger' }}">
                        {{ 'Ù†Ø´Ø·' if status.running else 'Ù…ØªÙˆÙ‚Ù' }}
                    </span>
                </p>
                {% if status.error %}
                <div class="alert alert-danger">{{ status.error }}</div>
                {% endif %}
                <button id="toggleBotBtn" class="btn btn-lg btn-{{ status.running ? 'warning' : 'success' }} mt-2">
                    {{ 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª' if status.running else 'ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª' }}
                </button>
            </div>
        </div>

        <!-- Ø§Ù„ØªÙ†Ø¨Ø¤ Ø§Ù„Ø­Ø§Ù„ÙŠ -->
        <div class="card mb-4">
            <div class="card-header">Ø§Ù„ØªÙ†Ø¨Ø¤ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
            <div class="card-body text-center">
                <div id="signalBox" class="signal-box alert alert-info">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                <button id="predictBtn" class="btn btn-primary">Ø·Ù„Ø¨ ØªÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>

        <!-- Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ -->
        <div class="card mb-4">
            <div class="card-header">ØªØ¯Ø§ÙˆÙ„ ÙŠØ¯ÙˆÙŠ</div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="amountInput" class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© (BTC)</label>
                    <input type="number" step="any" id="amountInput" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 0.001">
                </div>
                <button id="buyBtn" class="btn btn-success me-2">Ø´Ø±Ø§Ø¡</button>
                <button id="sellBtn" class="btn btn-danger">Ø¨ÙŠØ¹</button>
                <div id="manualTradeResult" class="mt-3"></div>
            </div>
        </div>

        <!-- Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
        <div class="card">
            <div class="card-header">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
            <div class="card-body p-0">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th>Ø§Ù„Ø³Ø¹Ø±</th>
                            <th>Ø§Ù„ÙˆÙ‚Øª</th>
                            <th>Ø§Ù„Ø±Ø¨Ø­</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if status.trade_history|length == 0 %}
                        <tr><td colspan="5" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø¹Ø¯</td></tr>
                        {% else %}
                        {% for trade in status.trade_history reversed %}
                        <tr>
                            <td>{{ trade.type }}</td>
                            <td>{{ "%.6f"|format(trade.amount) }}</td>
                            <td>${{ "%.2f"|format(trade.price) }}</td>
                            <td>{{ trade.timestamp }}</td>
                            <td>
                                {% if trade.profit %}
                                    {% set profit = "%.2f"|format(trade.profit) %}
                                    {% if profit|float > 0 %}
                                        <span class="text-success">+{{ profit }}$</span>
                                    {% elif profit|float < 0 %}
                                        <span class="text-danger">{{ profit }}$</span>
                                    {% else %}
                                        {{ profit }}$
                                    {% endif %}
                                {% else %}
                                    ---
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> 

    <!-- JavaScript Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨ÙˆØª -->
    <script>
        const predictBtn = document.getElementById('predictBtn');
        const signalBox = document.getElementById('signalBox');
        const toggleBotBtn = document.getElementById('toggleBotBtn');
        const buyBtn = document.getElementById('buyBtn');
        const sellBtn = document.getElementById('sellBtn');
        const amountInput = document.getElementById('amountInput');
        const manualTradeResult = document.getElementById('manualTradeResult');

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙ‚Ø¹
        function getPrediction() {
            fetch('/predict')
                .then(res => res.json())
                .then(data => {
                    let text = data.message || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙ‚Ø¹';
                    let cls = 'alert-info';

                    if (data.signal === 1) cls = 'alert-success';
                    else if (data.signal === 0) cls = 'alert-danger';

                    signalBox.className = `signal-box ${cls}`;
                    signalBox.textContent = text;
                })
                .catch(err => {
                    signalBox.className = 'signal-box alert-warning';
                    signalBox.textContent = 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙ‚Ø¹';
                    console.error(err);
                });
        }

        // ØªØ´ØºÙŠÙ„ Ø£Ùˆ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª
        toggleBotBtn.addEventListener('click', () => {
            const action = status.running ? 'stop' : 'start';
            fetch(`/${action}`, {
                method: 'GET'
            }).then(res => res.json())
              .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª');
                }
            });
        });

        // Ø´Ø±Ø§Ø¡ ÙŠØ¯ÙˆÙŠ
        buyBtn.addEventListener('click', () => {
            const amount = amountInput.value;
            if (!amount || amount <= 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©');
                return;
            }
            sendManualTrade('buy', amount);
        });

        // Ø¨ÙŠØ¹ ÙŠØ¯ÙˆÙŠ
        sellBtn.addEventListener('click', () => {
            const amount = amountInput.value;
            if (!amount || amount <= 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©');
                return;
            }
            sendManualTrade('sell', amount);
        });

        function sendManualTrade(action, amount) {
            fetch('/manual-trade', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, amount })
            }).then(res => res.json())
              .then(data => {
                  manualTradeResult.innerHTML = `<div class="alert alert-${data.status === 'success' ? 'success' : 'danger'}">${data.message}</div>`;
                  setTimeout(() => manualTradeResult.innerHTML = '', 3000);
              });
        }

        // ØªÙØ¹ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        predictBtn.addEventListener('click', getPrediction);
        window.onload = () => getPrediction();
    </script>
</body>
</html>
